<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Canal de Telegram</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&family=Sora:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --bg-a: #060c18;
      --bg-b: #0f1a31;
      --bg-c: #0d1426;
      --surface: #111a2c;
      --surface-strong: #18243a;
      --border: #2f3e5a;
      --text: #f7f9ff;
      --muted: #b7c3e0;
      --accent: #33d27a;
      --accent-strong: #19ba65;
      --secondary-btn: #2b3650;
      --secondary-btn-hover: #354567;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Manrope", "Avenir Next", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, #1f3f7e55, transparent 60%),
        radial-gradient(900px 600px at 100% 10%, #2c8f7b33, transparent 60%),
        linear-gradient(145deg, var(--bg-a), var(--bg-b) 55%, var(--bg-c));
    }

    .wrap {
      width: min(100%, 860px);
      margin: 0 auto;
      padding: clamp(18px, 4vw, 42px);
    }

    .card {
      background: linear-gradient(180deg, #16233a 0%, var(--surface) 100%);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: clamp(20px, 4vw, 34px);
      box-shadow:
        0 16px 44px rgba(2, 8, 20, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }

    .kicker {
      margin: 0 0 12px;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #8fd0ff;
      font-weight: 700;
    }

    h1 {
      font-family: "Sora", "Avenir Next", sans-serif;
      font-size: clamp(28px, 4.8vw, 42px);
      line-height: 1.12;
      margin: 0;
    }

    .lead {
      margin: 14px 0 0;
      color: var(--muted);
      line-height: 1.55;
      max-width: 62ch;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 22px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      border: 0;
      border-radius: 14px;
      padding: 15px 16px;
      font-weight: 800;
      cursor: pointer;
      font-size: 15px;
      transition: transform .18s ease, filter .18s ease, background-color .18s ease;
    }

    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .primary {
      background: linear-gradient(180deg, var(--accent), var(--accent-strong));
      color: #072111;
    }

    .primary:hover { filter: brightness(1.05); }

    .secondary {
      background: var(--secondary-btn);
      color: #f5f8ff;
    }

    .secondary:hover { background: var(--secondary-btn-hover); }

    .hint {
      margin-top: 14px;
      font-size: 13px;
      color: #d3dbef;
      line-height: 1.45;
    }

    .meta {
      margin-top: 14px;
      display: grid;
      gap: 6px;
    }

    .small {
      font-size: 12px;
      color: #a9b6d8;
    }

    a {
      color: #8de9be;
      text-underline-offset: 2px;
    }

    .stats {
      display: none;
      margin-top: 12px;
      white-space: pre-wrap;
      background: #101827;
      border: 1px solid #2d3a58;
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      color: #cfd8ef;
    }

    .footer {
      margin-top: 18px;
      text-align: center;
      font-size: 12px;
      color: #8f9ec2;
    }

    @media (min-width: 640px) {
      .actions { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <p class="kicker">Comunidad Telegram</p>
      <h1>Únete al canal oficial</h1>
      <p class="lead">Accede a nuevas plantillas, recursos y actualizaciones. Si estás en un navegador embebido, abre en navegador y vuelve a intentar.</p>

      <div class="actions">
        <button class="btn primary" id="joinBtn">Abrir Telegram</button>
        <button class="btn secondary" id="webBtn">Abrir enlace web (t.me)</button>
      </div>

      <div class="hint" id="hint"></div>
      <div class="meta">
        <div class="small" id="campaignInfo"></div>
        <div class="small">Canal: <a href="https://t.me/templateswordpress" rel="noopener noreferrer">t.me/templateswordpress</a></div>
      </div>
      <pre class="stats" id="statsBox"></pre>
    </div>

    <footer class="footer">Desarrollado por Ject - Todos los derechos reservados <span id="year"></span>.</footer>
  </div>

  <script>
    // Canal configurado
    const USERNAME = "templateswordpress";
    const TME_LINK = `https://t.me/${USERNAME}`;
    const TG_DEEP  = `tg://resolve?domain=${USERNAME}`;
    // Android: en varios webviews embebidos, intent:// tiene mejor tasa que tg://
    const TG_INTENT = `intent://t.me/${USERNAME}#Intent;scheme=https;package=org.telegram.messenger;end`;

    const ua = navigator.userAgent.toLowerCase();
    const isAndroid = ua.includes("android");
    const isTikTok = ua.includes("tiktok");
    const isInstagram = ua.includes("instagram");
    const isFacebook = ua.includes("fbav") || ua.includes("fban");
    const isInApp = isTikTok || isInstagram || isFacebook;

    const hintEl = document.getElementById("hint");
    const campaignInfoEl = document.getElementById("campaignInfo");
    const statsBoxEl = document.getElementById("statsBox");
    const yearEl = document.getElementById("year");
    const params = new URLSearchParams(window.location.search);
    yearEl.textContent = new Date().getFullYear();

    // UTM capture (se usa para anexar tracking al link web y para conteo local)
    const UTM_KEYS = ["utm_source", "utm_medium", "utm_campaign", "utm_term", "utm_content"];
    const utm = {};
    UTM_KEYS.forEach((k) => {
      const v = params.get(k);
      if (v) utm[k] = v;
    });

    const campaignKey = [
      utm.utm_source || "direct",
      utm.utm_medium || "none",
      utm.utm_campaign || "default"
    ].join("|");

    function withQuery(baseUrl, extra) {
      const url = new URL(baseUrl);
      Object.keys(extra).forEach((k) => {
        if (extra[k]) url.searchParams.set(k, extra[k]);
      });
      return url.toString();
    }

    const trackedTmeLink = withQuery(TME_LINK, utm);

    function loadStats() {
      try {
        const raw = localStorage.getItem("tg_campaign_stats");
        return raw ? JSON.parse(raw) : {};
      } catch {
        return {};
      }
    }

    function saveStats(stats) {
      try {
        localStorage.setItem("tg_campaign_stats", JSON.stringify(stats));
      } catch {
        // Ignore storage errors (private mode / blocked storage)
      }
    }

    function increment(metric) {
      const stats = loadStats();
      if (!stats[campaignKey]) {
        stats[campaignKey] = {
          views: 0,
          open_app_clicks: 0,
          open_web_clicks: 0,
          open_web_fallbacks: 0
        };
      }
      stats[campaignKey][metric] = (stats[campaignKey][metric] || 0) + 1;
      saveStats(stats);
    }

    function renderStatsIfRequested() {
      if (params.get("stats") !== "1") return;
      const stats = loadStats();
      statsBoxEl.style.display = "block";
      statsBoxEl.textContent = "Contador local (este dispositivo):\n" + JSON.stringify(stats, null, 2);
    }

    if (Object.keys(utm).length > 0) {
      campaignInfoEl.textContent =
        `Campaña detectada: ${campaignKey.replace(/\|/g, " / ")}`;
    } else {
      campaignInfoEl.textContent = "Campaña detectada: tráfico directo";
    }

    increment("views");
    renderStatsIfRequested();

    if (isTikTok) {
      hintEl.textContent =
        "Estás dentro del navegador de TikTok. TikTok puede bloquear la apertura directa de Telegram; si no abre, toca ⋯ y elige “Abrir en navegador”, luego vuelve a tocar “Abrir Telegram”.";
    } else if (isInApp) {
      hintEl.textContent =
        "Nota: Estás dentro de un navegador embebido. Si no abre Telegram, usa “Abrir en navegador” y prueba de nuevo.";
    } else {
      hintEl.textContent = "Si no tienes Telegram instalado, se abrirá el enlace web.";
    }

    document.getElementById("joinBtn").addEventListener("click", () => {
      increment("open_app_clicks");
      // Intento 1: Android intent://, otros tg://
      const firstTryLink = isAndroid ? TG_INTENT : TG_DEEP;
      let fallbackDone = false;

      const fallbackTimer = setTimeout(() => {
        fallbackDone = true;
        increment("open_web_fallbacks");
        window.location.href = trackedTmeLink;
      }, 1500);

      const clearFallback = () => {
        if (fallbackDone) return;
        clearTimeout(fallbackTimer);
        document.removeEventListener("visibilitychange", onVisibilityChange);
        window.removeEventListener("pagehide", onPageHide);
      };

      const onVisibilityChange = () => {
        if (document.hidden) {
          clearFallback();
        }
      };

      const onPageHide = () => {
        clearFallback();
      };

      document.addEventListener("visibilitychange", onVisibilityChange);
      window.addEventListener("pagehide", onPageHide, { once: true });

      window.location.href = firstTryLink;
    });

    document.getElementById("webBtn").addEventListener("click", () => {
      increment("open_web_clicks");
      window.location.href = trackedTmeLink;
    });
  </script>
</body>
</html>
